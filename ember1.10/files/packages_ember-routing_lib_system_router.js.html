<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>packages/ember-routing/lib/system/router.js - The Ember API</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="The Ember API"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.10.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Backburner.html">Backburner</a></li>
            
                <li><a href="../classes/Ember.html">Ember</a></li>
            
                <li><a href="../classes/Ember._BoundView.html">Ember._BoundView</a></li>
            
                <li><a href="../classes/Ember._Metamorph.html">Ember._Metamorph</a></li>
            
                <li><a href="../classes/Ember._MetamorphView.html">Ember._MetamorphView</a></li>
            
                <li><a href="../classes/Ember._SimpleMetamorphView.html">Ember._SimpleMetamorphView</a></li>
            
                <li><a href="../classes/Ember.ActionHandler.html">Ember.ActionHandler</a></li>
            
                <li><a href="../classes/Ember.Application.html">Ember.Application</a></li>
            
                <li><a href="../classes/Ember.Array.html">Ember.Array</a></li>
            
                <li><a href="../classes/Ember.ArrayController.html">Ember.ArrayController</a></li>
            
                <li><a href="../classes/Ember.ArrayProxy.html">Ember.ArrayProxy</a></li>
            
                <li><a href="../classes/Ember.AutoLocation.html">Ember.AutoLocation</a></li>
            
                <li><a href="../classes/Ember.Binding.html">Ember.Binding</a></li>
            
                <li><a href="../classes/Ember.Checkbox.html">Ember.Checkbox</a></li>
            
                <li><a href="../classes/Ember.CollectionView.html">Ember.CollectionView</a></li>
            
                <li><a href="../classes/Ember.Comparable.html">Ember.Comparable</a></li>
            
                <li><a href="../classes/Ember.Component.html">Ember.Component</a></li>
            
                <li><a href="../classes/Ember.ComponentTemplateDeprecation.html">Ember.ComponentTemplateDeprecation</a></li>
            
                <li><a href="../classes/Ember.ComputedProperty.html">Ember.ComputedProperty</a></li>
            
                <li><a href="../classes/Ember.ContainerDebugAdapter.html">Ember.ContainerDebugAdapter</a></li>
            
                <li><a href="../classes/Ember.ContainerView.html">Ember.ContainerView</a></li>
            
                <li><a href="../classes/Ember.Controller.html">Ember.Controller</a></li>
            
                <li><a href="../classes/Ember.ControllerContentModelAliasDeprecation.html">Ember.ControllerContentModelAliasDeprecation</a></li>
            
                <li><a href="../classes/Ember.ControllerMixin.html">Ember.ControllerMixin</a></li>
            
                <li><a href="../classes/Ember.Copyable.html">Ember.Copyable</a></li>
            
                <li><a href="../classes/Ember.CoreObject.html">Ember.CoreObject</a></li>
            
                <li><a href="../classes/Ember.CoreView.html">Ember.CoreView</a></li>
            
                <li><a href="../classes/Ember.DataAdapter.html">Ember.DataAdapter</a></li>
            
                <li><a href="../classes/Ember.DefaultResolver.html">Ember.DefaultResolver</a></li>
            
                <li><a href="../classes/Ember.Deferred.html">Ember.Deferred</a></li>
            
                <li><a href="../classes/Ember.Descriptor.html">Ember.Descriptor</a></li>
            
                <li><a href="../classes/Ember.EachProxy.html">Ember.EachProxy</a></li>
            
                <li><a href="../classes/Ember.Enumerable.html">Ember.Enumerable</a></li>
            
                <li><a href="../classes/Ember.EnumerableUtils.html">Ember.EnumerableUtils</a></li>
            
                <li><a href="../classes/Ember.Error.html">Ember.Error</a></li>
            
                <li><a href="../classes/Ember.EventDispatcher.html">Ember.EventDispatcher</a></li>
            
                <li><a href="../classes/Ember.Evented.html">Ember.Evented</a></li>
            
                <li><a href="../classes/Ember.FEATURES.html">Ember.FEATURES</a></li>
            
                <li><a href="../classes/Ember.Freezable.html">Ember.Freezable</a></li>
            
                <li><a href="../classes/Ember.Handlebars.html">Ember.Handlebars</a></li>
            
                <li><a href="../classes/Ember.Handlebars.helpers.html">Ember.Handlebars.helpers</a></li>
            
                <li><a href="../classes/Ember.HashLocation.html">Ember.HashLocation</a></li>
            
                <li><a href="../classes/Ember.HistoryLocation.html">Ember.HistoryLocation</a></li>
            
                <li><a href="../classes/Ember.HTMLBars.html">Ember.HTMLBars</a></li>
            
                <li><a href="../classes/Ember.HTMLBars.Helper.html">Ember.HTMLBars.Helper</a></li>
            
                <li><a href="../classes/Ember.inject.html">Ember.inject</a></li>
            
                <li><a href="../classes/Ember.InjectedProperty.html">Ember.InjectedProperty</a></li>
            
                <li><a href="../classes/Ember.Instrumentation.html">Ember.Instrumentation</a></li>
            
                <li><a href="../classes/Ember.LinkView.html">Ember.LinkView</a></li>
            
                <li><a href="../classes/Ember.Location.html">Ember.Location</a></li>
            
                <li><a href="../classes/Ember.Logger.html">Ember.Logger</a></li>
            
                <li><a href="../classes/Ember.Map.html">Ember.Map</a></li>
            
                <li><a href="../classes/Ember.MapWithDefault.html">Ember.MapWithDefault</a></li>
            
                <li><a href="../classes/Ember.Mixin.html">Ember.Mixin</a></li>
            
                <li><a href="../classes/Ember.MutableArray.html">Ember.MutableArray</a></li>
            
                <li><a href="../classes/Ember.MutableEnumerable.html">Ember.MutableEnumerable</a></li>
            
                <li><a href="../classes/Ember.Namespace.html">Ember.Namespace</a></li>
            
                <li><a href="../classes/Ember.NativeArray.html">Ember.NativeArray</a></li>
            
                <li><a href="../classes/Ember.NoneLocation.html">Ember.NoneLocation</a></li>
            
                <li><a href="../classes/Ember.Object.html">Ember.Object</a></li>
            
                <li><a href="../classes/Ember.ObjectController.html">Ember.ObjectController</a></li>
            
                <li><a href="../classes/Ember.ObjectProxy.html">Ember.ObjectProxy</a></li>
            
                <li><a href="../classes/Ember.Observable.html">Ember.Observable</a></li>
            
                <li><a href="../classes/Ember.OrderedSet.html">Ember.OrderedSet</a></li>
            
                <li><a href="../classes/Ember.platform.html">Ember.platform</a></li>
            
                <li><a href="../classes/Ember.PromiseProxyMixin.html">Ember.PromiseProxyMixin</a></li>
            
                <li><a href="../classes/Ember.ProxyMixin.html">Ember.ProxyMixin</a></li>
            
                <li><a href="../classes/Ember.ReduceComputedProperty.html">Ember.ReduceComputedProperty</a></li>
            
                <li><a href="../classes/Ember.Route.html">Ember.Route</a></li>
            
                <li><a href="../classes/Ember.Router.html">Ember.Router</a></li>
            
                <li><a href="../classes/Ember.run.html">Ember.run</a></li>
            
                <li><a href="../classes/Ember.Select.html">Ember.Select</a></li>
            
                <li><a href="../classes/Ember.Service.html">Ember.Service</a></li>
            
                <li><a href="../classes/Ember.Set.html">Ember.Set</a></li>
            
                <li><a href="../classes/Ember.SortableMixin.html">Ember.SortableMixin</a></li>
            
                <li><a href="../classes/Ember.String.html">Ember.String</a></li>
            
                <li><a href="../classes/Ember.SubArray.html">Ember.SubArray</a></li>
            
                <li><a href="../classes/Ember.TargetActionSupport.html">Ember.TargetActionSupport</a></li>
            
                <li><a href="../classes/Ember.Test.html">Ember.Test</a></li>
            
                <li><a href="../classes/Ember.Test.Adapter.html">Ember.Test.Adapter</a></li>
            
                <li><a href="../classes/Ember.Test.QUnitAdapter.html">Ember.Test.QUnitAdapter</a></li>
            
                <li><a href="../classes/Ember.TextArea.html">Ember.TextArea</a></li>
            
                <li><a href="../classes/Ember.TextField.html">Ember.TextField</a></li>
            
                <li><a href="../classes/Ember.TextSupport.html">Ember.TextSupport</a></li>
            
                <li><a href="../classes/Ember.TrackedArray.html">Ember.TrackedArray</a></li>
            
                <li><a href="../classes/Ember.View.html">Ember.View</a></li>
            
                <li><a href="../classes/Ember.ViewTargetActionSupport.html">Ember.ViewTargetActionSupport</a></li>
            
                <li><a href="../classes/Function.html">Function</a></li>
            
                <li><a href="../classes/HandlebarsCompatibleHelper.html">HandlebarsCompatibleHelper</a></li>
            
                <li><a href="../classes/Libraries.html">Libraries</a></li>
            
                <li><a href="../classes/RSVP.html">RSVP</a></li>
            
                <li><a href="../classes/RSVP.EventTarget.html">RSVP.EventTarget</a></li>
            
                <li><a href="../classes/RSVP.Promise.html">RSVP.Promise</a></li>
            
                <li><a href="../classes/String.html">String</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/ember.html">ember</a></li>
            
                <li><a href="../modules/ember-application.html">ember-application</a></li>
            
                <li><a href="../modules/ember-debug.html">ember-debug</a></li>
            
                <li><a href="../modules/ember-extension-support.html">ember-extension-support</a></li>
            
                <li><a href="../modules/ember-handlebars.html">ember-handlebars</a></li>
            
                <li><a href="../modules/ember-htmlbars.html">ember-htmlbars</a></li>
            
                <li><a href="../modules/ember-metal.html">ember-metal</a></li>
            
                <li><a href="../modules/ember-routing.html">ember-routing</a></li>
            
                <li><a href="../modules/ember-routing-handlebars.html">ember-routing-handlebars</a></li>
            
                <li><a href="../modules/ember-routing-htmlbars.html">ember-routing-htmlbars</a></li>
            
                <li><a href="../modules/ember-routing-views.html">ember-routing-views</a></li>
            
                <li><a href="../modules/ember-runtime.html">ember-runtime</a></li>
            
                <li><a href="../modules/ember-testing.html">ember-testing</a></li>
            
                <li><a href="../modules/ember-views.html">ember-views</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: packages/ember-routing/lib/system/router.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
import Ember from &quot;ember-metal/core&quot;; // FEATURES, Logger, assert
import EmberError from &quot;ember-metal/error&quot;;
import { get } from &quot;ember-metal/property_get&quot;;
import { set } from &quot;ember-metal/property_set&quot;;
import { defineProperty } from &quot;ember-metal/properties&quot;;
import { computed } from &quot;ember-metal/computed&quot;;
import merge from &quot;ember-metal/merge&quot;;
import run from &quot;ember-metal/run_loop&quot;;

import { fmt } from &quot;ember-runtime/system/string&quot;;
import EmberObject from &quot;ember-runtime/system/object&quot;;
import Evented from &quot;ember-runtime/mixins/evented&quot;;
import EmberRouterDSL from &quot;ember-routing/system/dsl&quot;;
import EmberView from &quot;ember-views/views/view&quot;;
import EmberLocation from &quot;ember-routing/location/api&quot;;
import _MetamorphView from &quot;ember-views/views/metamorph_view&quot;;
import {
  routeArgs,
  getActiveTargetName,
  stashParamNames
} from &quot;ember-routing/utils&quot;;
import { create } from &quot;ember-metal/platform&quot;;

/**
@module ember
@submodule ember-routing
*/

import Router from &#x27;router&#x27;;
import &#x27;router/transition&#x27;;

function K() { return this; }

var slice = [].slice;

/**
  The &#x60;Ember.Router&#x60; class manages the application state and URLs. Refer to
  the [routing guide](http://emberjs.com/guides/routing/) for documentation.

  @class Router
  @namespace Ember
  @extends Ember.Object
  @uses Ember.Evented
*/
var EmberRouter = EmberObject.extend(Evented, {
  /**
    The &#x60;location&#x60; property determines the type of URL&#x27;s that your
    application will use.

    The following location types are currently available:

    * &#x60;hash&#x60;
    * &#x60;history&#x60;
    * &#x60;none&#x60;

    @property location
    @default &#x27;hash&#x27;
    @see {Ember.Location}
  */
  location: &#x27;hash&#x27;,

  /**
   Represents the URL of the root of the application, often &#x27;/&#x27;. This prefix is
   assumed on all routes defined on this router.

   @property rootURL
   @default &#x27;/&#x27;
  */
  rootURL: &#x27;/&#x27;,

  init: function() {
    this.router = this.constructor.router || this.constructor.map(K);
    this._activeViews = {};
    this._setupLocation();
    this._qpCache = {};
    this._queuedQPChanges = {};

    if (get(this, &#x27;namespace.LOG_TRANSITIONS_INTERNAL&#x27;)) {
      this.router.log = Ember.Logger.debug;
    }
  },

  /**
    Represents the current URL.

    @method url
    @return {String} The current URL.
  */
  url: computed(function() {
    return get(this, &#x27;location&#x27;).getURL();
  }),

  /**
    Initializes the current router instance and sets up the change handling
    event listeners used by the instances &#x60;location&#x60; implementation.

    A property named &#x60;initialURL&#x60; will be used to determine the initial URL.
    If no value is found &#x60;/&#x60; will be used.

    @method startRouting
    @private
  */
  startRouting: function() {
    this.router = this.router || this.constructor.map(K);

    var router = this.router;
    var location = get(this, &#x27;location&#x27;);
    var container = this.container;
    var self = this;
    var initialURL = get(this, &#x27;initialURL&#x27;);
    var initialTransition;

    // Allow the Location class to cancel the router setup while it refreshes
    // the page
    if (get(location, &#x27;cancelRouterSetup&#x27;)) {
      return;
    }

    this._setupRouter(router, location);

    container.register(&#x27;view:default&#x27;, _MetamorphView);
    container.register(&#x27;view:toplevel&#x27;, EmberView.extend());

    location.onUpdateURL(function(url) {
      self.handleURL(url);
    });

    if (typeof initialURL === &quot;undefined&quot;) {
      initialURL = location.getURL();
    }
    initialTransition = this.handleURL(initialURL);
    if (initialTransition &amp;&amp; initialTransition.error) {
      throw initialTransition.error;
    }
  },

  /**
    Handles updating the paths and notifying any listeners of the URL
    change.

    Triggers the router level &#x60;didTransition&#x60; hook.

    @method didTransition
    @private
    @since 1.2.0
  */
  didTransition: function(infos) {
    updatePaths(this);

    this._cancelLoadingEvent();

    this.notifyPropertyChange(&#x27;url&#x27;);

    // Put this in the runloop so url will be accurate. Seems
    // less surprising than didTransition being out of sync.
    run.once(this, this.trigger, &#x27;didTransition&#x27;);

    if (get(this, &#x27;namespace&#x27;).LOG_TRANSITIONS) {
      Ember.Logger.log(&quot;Transitioned into &#x27;&quot; + EmberRouter._routePath(infos) + &quot;&#x27;&quot;);
    }
  },

  handleURL: function(url) {
    // Until we have an ember-idiomatic way of accessing #hashes, we need to
    // remove it because router.js doesn&#x27;t know how to handle it.
    url = url.split(/#(.+)?/)[0];
    return this._doURLTransition(&#x27;handleURL&#x27;, url);
  },

  _doURLTransition: function(routerJsMethod, url) {
    var transition = this.router[routerJsMethod](url || &#x27;/&#x27;);
    listenForTransitionErrors(transition);
    return transition;
  },

  transitionTo: function() {
    var args = slice.call(arguments);
    var queryParams;
    if (resemblesURL(args[0])) {
      return this._doURLTransition(&#x27;transitionTo&#x27;, args[0]);
    }

    var possibleQueryParams = args[args.length-1];
    if (possibleQueryParams &amp;&amp; possibleQueryParams.hasOwnProperty(&#x27;queryParams&#x27;)) {
      queryParams = args.pop().queryParams;
    } else {
      queryParams = {};
    }

    var targetRouteName = args.shift();
    return this._doTransition(targetRouteName, args, queryParams);
  },

  intermediateTransitionTo: function() {
    this.router.intermediateTransitionTo.apply(this.router, arguments);

    updatePaths(this);

    var infos = this.router.currentHandlerInfos;
    if (get(this, &#x27;namespace&#x27;).LOG_TRANSITIONS) {
      Ember.Logger.log(&quot;Intermediate-transitioned into &#x27;&quot; + EmberRouter._routePath(infos) + &quot;&#x27;&quot;);
    }
  },

  replaceWith: function() {
    return this.transitionTo.apply(this, arguments).method(&#x27;replace&#x27;);
  },

  generate: function() {
    var url = this.router.generate.apply(this.router, arguments);
    return this.location.formatURL(url);
  },

  /**
    Determines if the supplied route is currently active.

    @method isActive
    @param routeName
    @return {Boolean}
    @private
  */
  isActive: function(routeName) {
    var router = this.router;
    return router.isActive.apply(router, arguments);
  },

  /**
    An alternative form of &#x60;isActive&#x60; that doesn&#x27;t require
    manual concatenation of the arguments into a single
    array.

    @method isActiveIntent
    @param routeName
    @param models
    @param queryParams
    @return {Boolean}
    @private
    @since 1.7.0
  */
  isActiveIntent: function(routeName, models, queryParams) {
    var router = this.router;
    return router.isActive.apply(router, arguments);
  },

  send: function(name, context) {
    this.router.trigger.apply(this.router, arguments);
  },

  /**
    Does this router instance have the given route.

    @method hasRoute
    @return {Boolean}
    @private
  */
  hasRoute: function(route) {
    return this.router.hasRoute(route);
  },

  /**
    Resets the state of the router by clearing the current route
    handlers and deactivating them.

    @private
    @method reset
   */
  reset: function() {
    this.router.reset();
  },

  _lookupActiveView: function(templateName) {
    var active = this._activeViews[templateName];
    return active &amp;&amp; active[0];
  },

  _connectActiveView: function(templateName, view) {
    var existing = this._activeViews[templateName];

    if (existing) {
      existing[0].off(&#x27;willDestroyElement&#x27;, this, existing[1]);
    }

    function disconnectActiveView() {
      delete this._activeViews[templateName];
    }

    this._activeViews[templateName] = [view, disconnectActiveView];
    view.one(&#x27;willDestroyElement&#x27;, this, disconnectActiveView);
  },

  _setupLocation: function() {
    var location = get(this, &#x27;location&#x27;);
    var rootURL = get(this, &#x27;rootURL&#x27;);

    if (rootURL &amp;&amp; this.container &amp;&amp; !this.container.has(&#x27;-location-setting:root-url&#x27;)) {
      this.container.register(&#x27;-location-setting:root-url&#x27;, rootURL, {
        instantiate: false
      });
    }

    if (&#x27;string&#x27; === typeof location &amp;&amp; this.container) {
      var resolvedLocation = this.container.lookup(&#x27;location:&#x27; + location);

      if (&#x27;undefined&#x27; !== typeof resolvedLocation) {
        location = set(this, &#x27;location&#x27;, resolvedLocation);
      } else {
        // Allow for deprecated registration of custom location API&#x27;s
        var options = {
          implementation: location
        };

        location = set(this, &#x27;location&#x27;, EmberLocation.create(options));
      }
    }

    if (location !== null &amp;&amp; typeof location === &#x27;object&#x27;) {
      if (rootURL &amp;&amp; typeof rootURL === &#x27;string&#x27;) {
        location.rootURL = rootURL;
      }

      // ensure that initState is called AFTER the rootURL is set on
      // the location instance
      if (typeof location.initState === &#x27;function&#x27;) {
        location.initState();
      }
    }
  },

  _getHandlerFunction: function() {
    var seen = create(null);
    var container = this.container;
    var DefaultRoute = container.lookupFactory(&#x27;route:basic&#x27;);
    var self = this;

    return function(name) {
      var routeName = &#x27;route:&#x27; + name;
      var handler = container.lookup(routeName);

      if (seen[name]) {
        return handler;
      }

      seen[name] = true;

      if (!handler) {
        container.register(routeName, DefaultRoute.extend());
        handler = container.lookup(routeName);

        if (get(self, &#x27;namespace.LOG_ACTIVE_GENERATION&#x27;)) {
          Ember.Logger.info(&quot;generated -&gt; &quot; + routeName, { fullName: routeName });
        }
      }

      handler.routeName = name;
      return handler;
    };
  },

  _setupRouter: function(router, location) {
    var lastURL, emberRouter = this;

    router.getHandler = this._getHandlerFunction();

    var doUpdateURL = function() {
      location.setURL(lastURL);
    };

    router.updateURL = function(path) {
      lastURL = path;
      run.once(doUpdateURL);
    };

    if (location.replaceURL) {
      var doReplaceURL = function() {
        location.replaceURL(lastURL);
      };

      router.replaceURL = function(path) {
        lastURL = path;
        run.once(doReplaceURL);
      };
    }

    router.didTransition = function(infos) {
      emberRouter.didTransition(infos);
    };
  },

  _serializeQueryParams: function(targetRouteName, queryParams) {
    var groupedByUrlKey = {};

    forEachQueryParam(this, targetRouteName, queryParams, function(key, value, qp) {
      var urlKey = qp.urlKey;
      if (!groupedByUrlKey[urlKey]) {
        groupedByUrlKey[urlKey] = [];
      }
      groupedByUrlKey[urlKey].push({
        qp: qp,
        value: value
      });
      delete queryParams[key];
    });

    for (var key in groupedByUrlKey) {
      var qps = groupedByUrlKey[key];
      Ember.assert(fmt(&quot;You&#x27;re not allowed to have more than one controller &quot; +
                       &quot;property map to the same query param key, but both &quot; +
                       &quot;&#x60;%@&#x60; and &#x60;%@&#x60; map to &#x60;%@&#x60;. You can fix this by mapping &quot; +
                       &quot;one of the controller properties to a different query &quot; +
                       &quot;param key via the &#x60;as&#x60; config option, e.g. &#x60;%@: { as: &#x27;other-%@&#x27; }&#x60;&quot;,
                       [qps[0].qp.fprop, qps[1] ? qps[1].qp.fprop : &quot;&quot;, qps[0].qp.urlKey, qps[0].qp.prop, qps[0].qp.prop]), qps.length &lt;= 1);
      var qp = qps[0].qp;
      queryParams[qp.urlKey] = qp.route.serializeQueryParam(qps[0].value, qp.urlKey, qp.type);
    }
  },

  _deserializeQueryParams: function(targetRouteName, queryParams) {
    forEachQueryParam(this, targetRouteName, queryParams, function(key, value, qp) {
      delete queryParams[key];
      queryParams[qp.prop] = qp.route.deserializeQueryParam(value, qp.urlKey, qp.type);
    });
  },

  _pruneDefaultQueryParamValues: function(targetRouteName, queryParams) {
    var qps = this._queryParamsFor(targetRouteName);
    for (var key in queryParams) {
      var qp = qps.map[key];
      if (qp &amp;&amp; qp.sdef === queryParams[key]) {
        delete queryParams[key];
      }
    }
  },

  _doTransition: function(_targetRouteName, models, _queryParams) {
    var targetRouteName = _targetRouteName || getActiveTargetName(this.router);
    Ember.assert(&quot;The route &quot; + targetRouteName + &quot; was not found&quot;, targetRouteName &amp;&amp; this.router.hasRoute(targetRouteName));

    var queryParams = {};
    merge(queryParams, _queryParams);
    this._prepareQueryParams(targetRouteName, models, queryParams);

    var transitionArgs = routeArgs(targetRouteName, models, queryParams);
    var transitionPromise = this.router.transitionTo.apply(this.router, transitionArgs);

    listenForTransitionErrors(transitionPromise);

    return transitionPromise;
  },

  _prepareQueryParams: function(targetRouteName, models, queryParams) {
    this._hydrateUnsuppliedQueryParams(targetRouteName, models, queryParams);
    this._serializeQueryParams(targetRouteName, queryParams);
    this._pruneDefaultQueryParamValues(targetRouteName, queryParams);
  },

  /**
    Returns a merged query params meta object for a given route.
    Useful for asking a route what its known query params are.
   */
  _queryParamsFor: function(leafRouteName) {
    if (this._qpCache[leafRouteName]) {
      return this._qpCache[leafRouteName];
    }

    var map = {}, qps = [];
    this._qpCache[leafRouteName] = {
      map: map,
      qps: qps
    };

    var routerjs = this.router;
    var recogHandlerInfos = routerjs.recognizer.handlersFor(leafRouteName);

    for (var i = 0, len = recogHandlerInfos.length; i &lt; len; ++i) {
      var recogHandler = recogHandlerInfos[i];
      var route = routerjs.getHandler(recogHandler.handler);
      var qpMeta = get(route, &#x27;_qp&#x27;);

      if (!qpMeta) { continue; }

      merge(map, qpMeta.map);
      qps.push.apply(qps, qpMeta.qps);
    }

    return {
      qps: qps,
      map: map
    };
  },

  /*
    becomeResolved: function(payload, resolvedContext) {
      var params = this.serialize(resolvedContext);

      if (payload) {
        this.stashResolvedModel(payload, resolvedContext);
        payload.params = payload.params || {};
        payload.params[this.name] = params;
      }

      return this.factory(&#x27;resolved&#x27;, {
        context: resolvedContext,
        name: this.name,
        handler: this.handler,
        params: params
      });
    },
  */

  _hydrateUnsuppliedQueryParams: function(leafRouteName, contexts, queryParams) {
    var state = calculatePostTransitionState(this, leafRouteName, contexts);
    var handlerInfos = state.handlerInfos;
    var appCache = this._bucketCache;

    stashParamNames(this, handlerInfos);

    for (var i = 0, len = handlerInfos.length; i &lt; len; ++i) {
      var route = handlerInfos[i].handler;
      var qpMeta = get(route, &#x27;_qp&#x27;);

      for (var j = 0, qpLen = qpMeta.qps.length; j &lt; qpLen; ++j) {
        var qp = qpMeta.qps[j];
        var presentProp = qp.prop in queryParams  &amp;&amp; qp.prop ||
                          qp.fprop in queryParams &amp;&amp; qp.fprop;

        if (presentProp) {
          if (presentProp !== qp.fprop) {
            queryParams[qp.fprop] = queryParams[presentProp];
            delete queryParams[presentProp];
          }
        } else {
          var controllerProto = qp.cProto;
          var cacheMeta = get(controllerProto, &#x27;_cacheMeta&#x27;);

          var cacheKey = controllerProto._calculateCacheKey(qp.ctrl, cacheMeta[qp.prop].parts, state.params);
          queryParams[qp.fprop] = appCache.lookup(cacheKey, qp.prop, qp.def);
        }
      }
    }
  },

  _scheduleLoadingEvent: function(transition, originRoute) {
    this._cancelLoadingEvent();
    this._loadingStateTimer = run.scheduleOnce(&#x27;routerTransitions&#x27;, this, &#x27;_fireLoadingEvent&#x27;, transition, originRoute);
  },

  _fireLoadingEvent: function(transition, originRoute) {
    if (!this.router.activeTransition) {
      // Don&#x27;t fire an event if we&#x27;ve since moved on from
      // the transition that put us in a loading state.
      return;
    }

    transition.trigger(true, &#x27;loading&#x27;, transition, originRoute);
  },

  _cancelLoadingEvent: function () {
    if (this._loadingStateTimer) {
      run.cancel(this._loadingStateTimer);
    }
    this._loadingStateTimer = null;
  }
});

/*
  Helper function for iterating root-ward, starting
  from (but not including) the provided &#x60;originRoute&#x60;.

  Returns true if the last callback fired requested
  to bubble upward.

  @private
 */
function forEachRouteAbove(originRoute, transition, callback) {
  var handlerInfos = transition.state.handlerInfos;
  var originRouteFound = false;
  var handlerInfo, route;

  for (var i = handlerInfos.length - 1; i &gt;= 0; --i) {
    handlerInfo = handlerInfos[i];
    route = handlerInfo.handler;

    if (!originRouteFound) {
      if (originRoute === route) {
        originRouteFound = true;
      }
      continue;
    }

    if (callback(route, handlerInfos[i + 1].handler) !== true) {
      return false;
    }
  }
  return true;
}

// These get invoked when an action bubbles above ApplicationRoute
// and are not meant to be overridable.
var defaultActionHandlers = {

  willResolveModel: function(transition, originRoute) {
    originRoute.router._scheduleLoadingEvent(transition, originRoute);
  },

  error: function(error, transition, originRoute) {
    // Attempt to find an appropriate error substate to enter.
    var router = originRoute.router;

    var tryTopLevel = forEachRouteAbove(originRoute, transition, function(route, childRoute) {
      var childErrorRouteName = findChildRouteName(route, childRoute, &#x27;error&#x27;);
      if (childErrorRouteName) {
        router.intermediateTransitionTo(childErrorRouteName, error);
        return;
      }
      return true;
    });

    if (tryTopLevel) {
      // Check for top-level error state to enter.
      if (routeHasBeenDefined(originRoute.router, &#x27;application_error&#x27;)) {
        router.intermediateTransitionTo(&#x27;application_error&#x27;, error);
        return;
      }
    }

    logError(error, &#x27;Error while processing route: &#x27; + transition.targetName);
  },

  loading: function(transition, originRoute) {
    // Attempt to find an appropriate loading substate to enter.
    var router = originRoute.router;

    var tryTopLevel = forEachRouteAbove(originRoute, transition, function(route, childRoute) {
      var childLoadingRouteName = findChildRouteName(route, childRoute, &#x27;loading&#x27;);

      if (childLoadingRouteName) {
        router.intermediateTransitionTo(childLoadingRouteName);
        return;
      }

      // Don&#x27;t bubble above pivot route.
      if (transition.pivotHandler !== route) {
        return true;
      }
    });

    if (tryTopLevel) {
      // Check for top-level loading state to enter.
      if (routeHasBeenDefined(originRoute.router, &#x27;application_loading&#x27;)) {
        router.intermediateTransitionTo(&#x27;application_loading&#x27;);
        return;
      }
    }
  }
};

function logError(error, initialMessage) {
  var errorArgs = [];

  if (initialMessage) { errorArgs.push(initialMessage); }

  if (error) {
    if (error.message) { errorArgs.push(error.message); }
    if (error.stack)   { errorArgs.push(error.stack); }

    if (typeof error === &quot;string&quot;) { errorArgs.push(error); }
  }

  Ember.Logger.error.apply(this, errorArgs);
}

function findChildRouteName(parentRoute, originatingChildRoute, name) {
  var router = parentRoute.router;
  var childName;
  var targetChildRouteName = originatingChildRoute.routeName.split(&#x27;.&#x27;).pop();
  var namespace = parentRoute.routeName === &#x27;application&#x27; ? &#x27;&#x27; : parentRoute.routeName + &#x27;.&#x27;;

  if (Ember.FEATURES.isEnabled(&quot;ember-routing-named-substates&quot;)) {
    // First, try a named loading state, e.g. &#x27;foo_loading&#x27;
    childName = namespace + targetChildRouteName + &#x27;_&#x27; + name;
    if (routeHasBeenDefined(router, childName)) {
      return childName;
    }
  }

  // Second, try general loading state, e.g. &#x27;loading&#x27;
  childName = namespace + name;
  if (routeHasBeenDefined(router, childName)) {
    return childName;
  }
}

function routeHasBeenDefined(router, name) {
  var container = router.container;
  return router.hasRoute(name) &amp;&amp;
         (container.has(&#x27;template:&#x27; + name) || container.has(&#x27;route:&#x27; + name));
}

function triggerEvent(handlerInfos, ignoreFailure, args) {
  var name = args.shift();

  if (!handlerInfos) {
    if (ignoreFailure) { return; }
    throw new EmberError(&quot;Can&#x27;t trigger action &#x27;&quot; + name + &quot;&#x27; because your app hasn&#x27;t finished transitioning into its first route. To trigger an action on destination routes during a transition, you can call &#x60;.send()&#x60; on the &#x60;Transition&#x60; object passed to the &#x60;model/beforeModel/afterModel&#x60; hooks.&quot;);
  }

  var eventWasHandled = false;
  var handlerInfo, handler;

  for (var i = handlerInfos.length - 1; i &gt;= 0; i--) {
    handlerInfo = handlerInfos[i];
    handler = handlerInfo.handler;

    if (handler._actions &amp;&amp; handler._actions[name]) {
      if (handler._actions[name].apply(handler, args) === true) {
        eventWasHandled = true;
      } else {
        return;
      }
    }
  }

  if (defaultActionHandlers[name]) {
    defaultActionHandlers[name].apply(null, args);
    return;
  }

  if (!eventWasHandled &amp;&amp; !ignoreFailure) {
    throw new EmberError(&quot;Nothing handled the action &#x27;&quot; + name + &quot;&#x27;. If you did handle the action, this error can be caused by returning true from an action handler in a controller, causing the action to bubble.&quot;);
  }
}

function calculatePostTransitionState(emberRouter, leafRouteName, contexts) {
  var routerjs = emberRouter.router;
  var state = routerjs.applyIntent(leafRouteName, contexts);
  var handlerInfos = state.handlerInfos;
  var params = state.params;

  for (var i = 0, len = handlerInfos.length; i &lt; len; ++i) {
    var handlerInfo = handlerInfos[i];
    if (!handlerInfo.isResolved) {
      handlerInfo = handlerInfo.becomeResolved(null, handlerInfo.context);
    }
    params[handlerInfo.name] = handlerInfo.params;
  }
  return state;
}

function updatePaths(router) {
  var appController = router.container.lookup(&#x27;controller:application&#x27;);

  if (!appController) {
    // appController might not exist when top-level loading/error
    // substates have been entered since ApplicationRoute hasn&#x27;t
    // actually been entered at that point.
    return;
  }

  var infos = router.router.currentHandlerInfos;
  var path = EmberRouter._routePath(infos);

  if (!(&#x27;currentPath&#x27; in appController)) {
    defineProperty(appController, &#x27;currentPath&#x27;);
  }

  set(appController, &#x27;currentPath&#x27;, path);

  if (!(&#x27;currentRouteName&#x27; in appController)) {
    defineProperty(appController, &#x27;currentRouteName&#x27;);
  }

  set(appController, &#x27;currentRouteName&#x27;, infos[infos.length - 1].name);
}

EmberRouter.reopenClass({
  router: null,

  /**
    The &#x60;Router.map&#x60; function allows you to define mappings from URLs to routes
    and resources in your application. These mappings are defined within the
    supplied callback function using &#x60;this.resource&#x60; and &#x60;this.route&#x60;.

    &#x60;&#x60;&#x60;javascript
    App.Router.map(function({
      this.route(&#x27;about&#x27;);
      this.resource(&#x27;article&#x27;);
    }));
    &#x60;&#x60;&#x60;

    For more detailed examples please see
    [the guides](http://emberjs.com/guides/routing/defining-your-routes/).

    @method map
    @param callback
  */
  map: function(callback) {
    var router = this.router;
    if (!router) {
      router = new Router();

      if (Ember.FEATURES.isEnabled(&quot;ember-routing-will-change-hooks&quot;)) {
        router._willChangeContextEvent = &#x27;willChangeModel&#x27;;
      } else {
        router._triggerWillChangeContext = K;
        router._triggerWillLeave = K;
      }

      router.callbacks = [];
      router.triggerEvent = triggerEvent;
      this.reopenClass({ router: router });
    }

    var dsl = EmberRouterDSL.map(function() {
      this.resource(&#x27;application&#x27;, { path: &quot;/&quot; }, function() {
        for (var i=0; i &lt; router.callbacks.length; i++) {
          router.callbacks[i].call(this);
        }
        callback.call(this);
      });
    });

    router.callbacks.push(callback);
    router.map(dsl.generate());
    return router;
  },

  _routePath: function(handlerInfos) {
    var path = [];

    // We have to handle coalescing resource names that
    // are prefixed with their parent&#x27;s names, e.g.
    // [&#x27;foo&#x27;, &#x27;foo.bar.baz&#x27;] =&gt; &#x27;foo.bar.baz&#x27;, not &#x27;foo.foo.bar.baz&#x27;

    function intersectionMatches(a1, a2) {
      for (var i = 0, len = a1.length; i &lt; len; ++i) {
        if (a1[i] !== a2[i]) {
          return false;
        }
      }
      return true;
    }

    var name, nameParts, oldNameParts;
    for (var i=1, l=handlerInfos.length; i&lt;l; i++) {
      name = handlerInfos[i].name;
      nameParts = name.split(&quot;.&quot;);
      oldNameParts = slice.call(path);

      while (oldNameParts.length) {
        if (intersectionMatches(oldNameParts, nameParts)) {
          break;
        }
        oldNameParts.shift();
      }

      path.push.apply(path, nameParts.slice(oldNameParts.length));
    }

    return path.join(&quot;.&quot;);
  }
});

function listenForTransitionErrors(transition) {
  transition.then(null, function(error) {
    if (!error || !error.name) { return; }

    Ember.assert(&quot;The URL &#x27;&quot; + error.message + &quot;&#x27; did not match any routes in your application&quot;, error.name !== &quot;UnrecognizedURLError&quot;);

    return error;
  }, &#x27;Ember: Process errors from Router&#x27;);
}

function resemblesURL(str) {
  return typeof str === &#x27;string&#x27; &amp;&amp; ( str === &#x27;&#x27; || str.charAt(0) === &#x27;/&#x27;);
}

function forEachQueryParam(router, targetRouteName, queryParams, callback) {
  var qpCache = router._queryParamsFor(targetRouteName);

  for (var key in queryParams) {
    if (!queryParams.hasOwnProperty(key)) { continue; }
    var value = queryParams[key];
    var qp = qpCache.map[key];

    if (qp) {
      callback(key, value, qp);
    }
  }
}

export default EmberRouter;

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
